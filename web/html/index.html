<html>
<head>
  <script src="lib/highlight.min.js"></script>
  <script src="lib/jquery.min.js"></script>
  <script src="lib/bootstrap.min.js"></script>
  <script src="lib/jquery.mask.min.js"></script>
  <script src="lib/vis.min.js"></script>
  <script src="lib/conf.js"></script>

  <link href="lib/bootstrap.min.css" rel="stylesheet">
  <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
  <link href="lib/ie10-viewport-bug-workaround.css" rel="stylesheet">
  <link href="lib/vis.min.css" rel="stylesheet">
  <style type="text/css">
    body {
      padding-top: 50px;
    }
    .navbar-brand {
      padding:0;
      line-height: 2.8em;
    }
    .logo-header {
      max-height: 2.8em;
      padding: 0.1em;
    }
    .panel-heading {
      font-size: 1.3em;
    }
    .panel-heading>a {
        color:inherit;
    }
    .starter-template {
      padding: 40px 15px;
    }
    .modal-content {
        padding:10px;
        height: 100%;
    }
    .modal-dialog {
      width: 90%;
      height: 700px;
    }
    .modal-body {
      overflow-y: auto;
    }

    /* topology */
    #topology-panel {
      display:none;
    }
    #collapse_topology_icon {
      vertical-align:middle;
    }
    #id_modal_network .modal-header {
      padding: 0;
    }
    /* Setting modal network to fullscreen */
    #id_modal_network .modal-dialog {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #id_modal_network .modal-content {
      height: auto;
      min-height: 100%;
      border-radius: 0;
    }
    #mynetwork {
      height: 650px;
      border: 1px solid lightgray;
    }
    #render_colors_btn,
    #render_trace_btn,
    #render_btn {
      margin: 0 0 0 20px;
    }

    #switches_topology_table td {
      font-size: 0.85em;
      white-space: nowrap;
    }
    /* topology id */
    #switches_topology_table td:nth-child(1),
     #switches_topology_table td:nth-child(4) {
      width: 11em;
    }
    /* topology color */
    #switches_topology_table td:nth-child(2) {
      width: 5em;
      white-space: nowrap;
      font-weight:bold;
    }
    /* topology arrow */
    #switches_topology_table td:nth-child(3) {
      width: 3em;
    }
    /* topology color */
    #switches_topology_table td:nth-child(5) {
      width: 100%;
      white-space: nowrap;
      font-weight:bold;
    }
    #switches_topology_text li {
      list-style-type:none;
    }
    #switch-ports {
      display:none;
    }
    #switch-ports-content {
      padding-left: 0;
    }
    #switch-ports-content .list-group {
      padding:0;
    }
    #switch-ports-layer-form-content {
      display:none;
    }
    .switch-port-a {
      width: 8em;
      padding: 0.2em 1em 0.2em 1em;
      text-align: left;
    }
    .switch-port-a.active, .switch-port-a.active:hover, .switch-port-a.active:focus {
      color: #555;
      background-color: lightgray;
      border-color: lightgray;
    }
    #trace-result-content table {
      font-size: 0.8em;
    }
    .loading-icon-div {
      margin:0;
      padding: 0.5em 0 0 0;
      display:none;
    }
    .trace-result-panel,
    .trace-result-content {
      display:none;
    }
  </style>
  <script>
        var sdntrace = '';
        var sdncolor = '';

        /**
         * SDNColor utility to transform SDN color codes to CSS names.
         */
        var SDNColor = function() {
            this.colors = {'1':'darkseagreen', '10':'dodgerblue', '11':'chocolate', '100':'darkorange', '101':'darkviolet', '110':'darkturquoise', '111':'black' }
            this.trace_color_on = '#1AC91A';
            this.trace_color_off = 'lightgray';
            this.color_default = '#8EB5EA';

            /**
             * Get color CSS name.
             *     param code: binary color code
             *     return: CSS color name
             */
            this.get_color = function(code) {
                var result = null;
                $.each( this.colors, function( key, val ) {
                    if (key == code) {
                        result = val;
                    }
                });
                return result;
            }
        }

        var SDNTrace = function() {
            this.switches = [];
            this.topology = [];
            this.switch_colors = [];
            this.trace = [];
            this.has_trace_loop = false;

            /**
             * Return switch color object {'color', 'old_color'} given a switch ID.
             */
            this.get_switch_color = function(s_id) {
                var result = '';
                if (this.switch_colors) {
                    for (var x = 0; x < sdntrace.switch_colors.length; x++) {
                        if (sdntrace.switch_colors[x]['key'] == s_id) {
                            result = sdntrace.switch_colors[x]['val'];
                        }
                    }
                }
                return result;
            }

            /**
             * Render HTML of the switch list.
             */
            this.render_html_switches = function() {
                if (sdntrace.switches) {
                    html_content = ""
                    html_content += "<option>---</option>";

                    for (var x = 0; x < sdntrace.switches.length; x++) {
                        html_content += "<option value='" + sdntrace.switches[x].id + "'>" + sdntrace.switches[x].get_name_or_id();
                        html_content += "</option>";
                    }
                    $('#switches_select').html(html_content);
                }
            }

            /**
             * Render HTML of the topology.
             */
            this.render_html_topology = function() {
                if (sdntrace.topology) {
                    $('#mynetwork').show();
                    $('#topology-panel').show();

                    html_content = ""
                    html_content += "<div class='row'>";
                    html_content += "<div class='col-sm-12 col-md-12'>"
                    html_content += "<table id='switches_topology_table' class='table'><tbody>"

                    for (var x = 0; x < sdntrace.topology.length; x++) {
                        html_content += "<tr>"
                        html_content += "<td>";

                        // display nice switch name
                        var temp_switch = new Switch(sdntrace.topology[x]['key']);
                        html_content += temp_switch.get_name_or_id();

                        // start left content, origin switch
                        if (sdntrace.switch_colors && sdntrace.switch_colors.length > 0) {
                            var obj_color = sdntrace.get_switch_color(sdntrace.topology[x]['key']);
                            html_content += "</td><td><span style='color:" + sdncolor.get_color(obj_color['color']) +"'>" + obj_color['color'] + "</span>";
                            html_content += " (<span style='color:" + sdncolor.get_color(obj_color['old_color']) +"'>" + obj_color['old_color'] + "</span>) ";
                        } else {
                            html_content += "</td><td>";
                        }
                        html_content += "</td>";
                        // end left content, origin switch

                        html_content += "<td><span class='glyphicon glyphicon-arrow-right' aria-hidden='true'></span></td>";
                        html_content += "<td>"

                        // start right content, destination switch
                        if (sdntrace.topology[x]['val'] && sdntrace.topology[x]['val'].length > 0) {
                            var val_array = ("" + sdntrace.topology[x]['val']).split(",");
                            for (var y = 0; y < val_array.length; y++) {
                                html_content += "<li>"
                                // display nice switch name
                                var temp_switch = new Switch(val_array[y]);
                                html_content += temp_switch.get_name_or_id();
                                html_content += "</li>"
                            }
                            if (sdntrace.switch_colors && sdntrace.switch_colors.length > 0) {
                                html_content += "</td><td>";
                                for (var y = 0; y < val_array.length; y++) {
                                    var obj_color = sdntrace.get_switch_color(val_array[y]);
                                    html_content += "<li><span style='color:" + sdncolor.get_color(obj_color['color']) +"'>" + obj_color['color'] + "</span>";
                                    html_content += " (<span style='color:" + sdncolor.get_color(obj_color['old_color']) +"'>" + obj_color['old_color'] + "</span>) </li>";
                                }
                            } else {
                                html_content += "</td><td>";
                            }
                        } else {
                            html_content += "</td><td>";
                        }
                        html_content += "</td></tr>"
                        // end right content, destination switch
                    }
                    html_content += "</tbody></table>";
                    html_content += "</div>";

                    $('#switches_topology_text').html(html_content);
                }
            }

            /**
             * Call ajax to load the switch list with colors.
             */
            this.call_get_switch_colors = function() {

                var jqxhr = $.ajax({
                    url:"/sdntrace/switches/colors",
                    crossdomain:true,
                    dataType: 'json',
                }).done(function(jsonObj) {
                    $.each( jsonObj, function( key, val ) {
                        sdntrace.switch_colors.push({'key': key, 'val':val});
                    });
                    sdntrace.render_html_topology();
                    vislib.render_topology_colors();
                })
                .fail(function() {
                    console.log( "error" );
                })
                .always(function() {
                    console.log( "complete" );
                });
            };

            /**
             * Call ajax to load the switch list.
             */
            this.call_get_switches = function() {
                $('#switch-ports-layer-form-content').hide();
                $('#trace-result-panel').hide();

                var ajax_done = function(json) {
                    var jsonObj;
                    jsonObj= json;
                    for (var x = 0; x < jsonObj.length; x++) {
                        // storing switch values
                        sdntrace.switches.push(new Switch(jsonObj[x]));
                    }
                    sdntrace.switches = sdntrace.switches.sort();
                    sdntrace.switches = array_unique_fast(sdntrace.switches);

                    sdntrace.render_html_switches();
                }

                var jqxhr = $.ajax({
                    url:"/sdntrace/switches",
                    crossdomain:true,
                    dataType: 'json',
                }).done(function(json) {
                    ajax_done(json);
                })
                .fail(function() {
                    console.log( "error" );
                })
                .always(function() {
                    console.log( "complete" );
                });
            }

            /**
             * Call ajax to load the switch topology.
             */
            this.call_get_topology = function() {
                // hiding topology graphic panel
                $('#mynetwork').hide();

                var ajax_done = function(json) {
                    var jsonObj;
                    jsonObj= json;

                    // verify if the json is not a '{}' response
                    if (!jQuery.isEmptyObject(jsonObj)) {
                        $('#topology-panel').show();

                        $.each( jsonObj, function( key, val ) {
                            sdntrace.topology.push({'key': key, 'val':val});
                        });

                        sdntrace.topology = sdntrace.topology.sort(function(a, b) {
                            return a['key'].localeCompare(b['key']);
                        });
                        sdntrace.render_html_topology();

                        sdntrace.call_get_switch_colors();
                    }
                }

                var jqxhr = $.ajax({
                    url:"/sdntrace/switches/topology",
                    dataType: 'json',
                }).done(function(json) {
                    ajax_done(json);
                })
                .fail(function() {
                    console.log( "error" );
                })
                .always(function() {
                    console.log( "complete" );
                });
            }

            /**
             * Call ajax to load the switch's ports.
             * Render the port values and assign the click event.
             */
            this.call_get_switch_port = function(switch_id) {

                $('#switch-ports').show();
                $('#switch-ports-layer-form-content').hide();
                $('#trace-result-panel').hide();

                var ajax_done = function(json) {
                    var jsonObj;
                    jsonObj= json;

                    html_content = ""
                    html_content += "<div class='list-group'  data-toggle='buttons'>";
                    var has_port = false;
                    $.each( jsonObj, function( key, val ) {
                        var switch_port = new Port(key, val);

                        html_content += "<a href='#' class='list-group-item switch-port-a' data-port-id='" + switch_port.id +"'>" + switch_port.label + "</a>";
                        has_port = true;
                    });
                    if (!has_port) {
                        html_content += "This switch has no OpenFlow ports enabled.";
                    }
                    html_content += "</div>";
                    $('#switch-ports-content').html(html_content);

                    if (has_port) {
                        $('.switch-port-a').click(function() {
                            $('#switch-ports-layer-form-content').show();
                            $('#switch-ports-layer-form-content a:first').tab('show');
                            // storing the clicked port value
                            var port_id = $(this).attr('data-port-id');
                            $('#switch_port_hidden').val(port_id);
                            // hide trace result panel
                            $('#trace-result-panel').hide();
                            $('.switch-port-a').removeClass('active');
                            $(this).addClass('active');
                        });
                    }
                }

                var jqxhr = $.ajax({
                    url:"/sdntrace/switches/" + switch_id + "/ports",
                    dataType: 'json',
                }).done(function(json) {
                    ajax_done(json);
                })
                .fail(function() {
                    console.log( "error" );
                })
                .always(function() {
                    console.log( "complete" );
                });
            }

            /**
             * Build json string from form fields to send to trace layer 2 ajax.
             */
            this._build_trace_layer2_json = function() {
                var layer2 = new Object();
                layer2.trace = new Object();

                layer2.trace.switch = new Object();
                layer2.trace.switch.dpid = $('#switches_select').val();
                layer2.trace.switch.in_port = $('#switch_port_hidden').val();
                if (layer2.trace.switch.in_port) {
                    layer2.trace.switch.in_port = parseInt(layer2.trace.switch.in_port, 10);
                }

                layer2.trace.eth = new Object();
                layer2.trace.eth.dl_src = $('#l2_dl_src').val();
                layer2.trace.eth.dl_dst = $('#l2_dl_dst').val();
                layer2.trace.eth.dl_vlan = $('#l2_dl_vlan').val();
                if (layer2.trace.eth.dl_vlan) {
                    layer2.trace.eth.dl_vlan = parseInt(layer2.trace.eth.dl_vlan, 10);
                }
                layer2.trace.eth.dl_type = $('#l2_dl_type').val();

                layer2 = sdntrace._remove_empty_json_values(layer2);
                var layer2String = JSON.stringify(layer2);
                return layer2String;
            }

            /**
             * Build json string from form fields to send to trace layer 3 ajax.
             */
            this._build_trace_layer3_json = function() {
                var layer3 = new Object();
                layer3.trace = new Object();

                layer3.trace.switch = new Object();
                layer3.trace.switch.dpid = $('#switches_select').val();
                layer3.trace.switch.in_port = $('#switch_port_hidden').val();
                if (layer3.trace.switch.in_port) {
                    layer3.trace.switch.in_port = parseInt(layer3.trace.switch.in_port, 10);
                }

                layer3.trace.eth = new Object();
                layer3.trace.eth.dl_vlan = $('#l3_dl_vlan').val();
                if (layer3.trace.eth.dl_vlan) {
                    layer3.trace.eth.dl_vlan = parseInt(layer3.trace.eth.dl_vlan, 10);
                }

                layer3.trace.ip = new Object();
                layer3.trace.ip.nw_src = $('#l3_nw_src').val();
                layer3.trace.ip.nw_dst = $('#l3_nw_dst').val();
                layer3.trace.ip.nw_tos = $('#l3_nw_tos').val();
                if (layer3.trace.ip.nw_tos) {
                    layer3.trace.ip.nw_tos = parseInt(layer3.trace.ip.nw_tos, 10);
                }

                layer3.trace.tp = new Object();
                layer3.trace.tp.tp_src = $('#l3_tp_src').val();
                layer3.trace.tp.tp_dst = $('#l3_tp_dst').val();
                if (layer3.trace.tp.tp_dst) {
                    layer3.trace.tp.tp_dst = parseInt(layer3.trace.tp.tp_dst, 10);
                }
                layer3 = sdntrace._remove_empty_json_values(layer3);
                var layer3String = JSON.stringify(layer3);

                return layer3String;
            }

            /**
             * Build json string from form fields to send to full trace ajax.
             */
            this._build_trace_layerfull_json = function() {
                var layerfull = new Object();
                layerfull.trace = new Object();

                layerfull.trace.switch = new Object();
                layerfull.trace.switch.dpid = $('#switches_select').val();
                layerfull.trace.switch.in_port = $('#switch_port_hidden').val();
                if (layerfull.trace.switch.in_port) {
                    layerfull.trace.switch.in_port = parseInt(layerfull.trace.switch.in_port, 10);
                }

                layerfull.trace.eth = new Object();
                layerfull.trace.eth.dl_src = $('#lf_dl_src').val();
                layerfull.trace.eth.dl_dst = $('#lf_dl_dst').val();
                layerfull.trace.eth.dl_vlan = $('#lf_dl_vlan').val();
                if (layerfull.trace.eth.dl_vlan) {
                    layerfull.trace.eth.dl_vlan = parseInt(layerfull.trace.eth.dl_vlan, 10);
                }
                layerfull.trace.eth.dl_type = $('#lf_dl_type').val();

                layerfull.trace.ip = new Object();
                layerfull.trace.ip.nw_src = $('#lf_nw_src').val();
                layerfull.trace.ip.nw_dst = $('#lf_nw_dst').val();
                layerfull.trace.ip.nw_tos = $('#lf_nw_tos').val();
                if (layerfull.trace.ip.nw_tos) {
                    layerfull.trace.ip.nw_tos = parseInt(layerfull.trace.ip.nw_tos, 10);
                }
                layerfull.trace.tp = new Object();
                layerfull.trace.tp.tp_src = $('#lf_tp_src').val();
                layerfull.trace.tp.tp_dst = $('#lf_tp_dst').val();
                if (layerfull.trace.tp.tp_dst) {
                    layerfull.trace.tp.tp_dst = parseInt(layerfull.trace.tp.tp_dst, 10);
                }

                layerfull = sdntrace._remove_empty_json_values(layerfull);
                var layerfullString = JSON.stringify(layerfull);

                return layerfullString;
            }
            /**
             * Helper function to remove attributes with empty values from a json object.
             */
            this._remove_empty_json_values = function(obj) {
                for (var i in obj) {
                    for (var j in obj[i]) {
                        for (var w in obj[i][j]) {
                            if (obj[i][j][w] === null || obj[i][j][w] == '') {
                                delete obj[i][j][w];
                            }
                        }
                        if (jQuery.isEmptyObject(obj[i][j])) {
                            delete obj[i][j];
                        }
                    }
                    if (jQuery.isEmptyObject(obj[i])) {
                        delete obj[i];
                    }
                }
                return obj;
            }

            /**
             * Call ajax to trace.
             * Param:
             *    json_data: Data in json String format to send as PUT method.
             */
            this.call_trace_port = function(json_data) {
                $('#trace-result-content').html('');
                $('.loading-icon-div').show();

                var ajax_done = function(json) {
                    var jsonObj;
                    jsonObj= json;

                    // reseting sdntrace tracing variables
                    sdntrace.has_trace_loop = false;
                    sdntrace.trace = [];

                    // storing first element of trace;
                    sdntrace.trace.push({id:$('#switches_select').val(), port:$('#switch_port_hidden').val()});

                    html_content = ""
                    html_content += "<div class='row'><div class='col-sm-12'>Trace result: </div></div><div class='row'>";
                    html_content += "<div class='col-sm-10 col-md-5'><table class='table table-striped'>"
                    html_content += "<thead><tr><th>Switch/DPID</th><td>Incoming Port</th></tr></thead>"
                    html_content += "<tbody>"

                    $.each( jsonObj, function( key, val ) {
                        if (val == 'loop') {
                            html_content += "<tr><td>" + val + "</td></tr>";
                            // flag looping switch.
                            sdntrace.has_trace_loop = true;
                        } else {
                            html_content += "<tr><td>";

                            var temp_switch = new Switch(val['trace']['dpid']);
                            html_content += temp_switch.get_name_or_id();

                            html_content += "</td>";
                            html_content += "<td>" + val['trace']['port'] + "</td></tr>";
                            sdntrace.trace.push({id:val['trace']['dpid'], port:val['trace']['port']});
                        }
                    });
                    html_content += "</tbody></table></div></div>";

                    $('#trace-result-content').html(html_content);
                }

                var jqxhr = $.ajax({
                    url:"/sdntrace/trace",
                    type: 'PUT',
                    dataType: 'json',
                    data: json_data
                }).done(function(json) {
                    ajax_done(json);
                })
                .fail(function(responseObj) {
                    if (responseObj.responseJSON) {
                        $('#trace-result-content').html("<div class='bg-danger'>"+responseObj.responseJSON.error+"</div>");
                    } else {
                        $('#trace-result-content').html("<div class='bg-danger'>Trace error.</div>");
                    }
                })
                .always(function() {
                    $('.loading-icon-div').hide();
                    $('#trace-result-panel').show();
                });
            }
        }

        /**
         * Switch representation.
         */
        var Switch = function(switch_id) {
            this.id = switch_id;

            /**
             * Get switch fantasy name from configuration data.
             */
            this.get_name = function() {
                if (typeof SDNTRACE_CONF != 'undefined') {
                    var name = SDNTRACE_CONF.dict[this.id];
                    if (name != undefined) {
                        return name;
                    }
                }
                return null;
            }
            
            
            /**
             * Get switch fantasy name from configuration data.
             * If there is no name return the switch ID.
             */
            this.get_name_or_id = function() {
                if (typeof SDNTRACE_CONF != 'undefined') {
                    var name = SDNTRACE_CONF.dict[this.id];
                    if (name != undefined) {
                        return name;
                    }
                }
                return this.id;
            }

            /**
             * Get switch fantasy name from configuration data.
             * Return verbose name as: <ID> - <NAME>
             */
            this.get_verbose_name = function() {
                if (typeof SDNTRACE_CONF != 'undefined') {
                    var name = SDNTRACE_CONF.dict[this.id];
                    if (name != undefined) {
                        return this.id + ' - ' + name;
                    }
                }
                return this.id;
            }

            /**
             * Get switch fantasy name from configuration data.
             * Return verbose name to be used on vis.js: <ID>\n<NAME>
             */
            this.get_node_name = function() {
                if (typeof SDNTRACE_CONF != 'undefined') {
                    var name = SDNTRACE_CONF.dict[this.id];
                    if (name != undefined) {
                        return name;
                    }
                }
                return this.id;
            }
        }
        // Return switch id if the class is used with strings
        Switch.prototype.toString = function(){ return this.id; };


        /**
         * Switch port representation.
         */
        var Port = function(port_id, label) {
            this.id = port_id;
            this.label = label;
        }
        // Return switch port id if the class is used with strings
        Port.prototype.toString = function(){ return this.id; };


        var VIS = function() {
            this.nodes = null;
            this.edges = null;
            /**
             * Render topology using topology data saved in sdntrace object.
             * It uses the vis.js graph library.
             * You must load the sdntrace switch and topology data before trying to render the topology.
             */
            this.render_topology = function() {
                this._render_network(false, false);
            }
            this.render_topology_colors = function() {
                this._render_network(true, false);
            }
            this.render_topology_trace = function() {
                this._render_network(false, true);
            }

            /**
             * Create VIS network nodes.
             * We use the sdntrace.switch list to create the nodes and expect that the topology will have the same
             * node identification to draw the network edges.
             */
            this._create_network_nodes = function(with_colors, with_trace) {
                // create an array with nodes
                var nodesArray = [];
                for (x = 0; x < sdntrace.switches.length; x++) {
                    node_id = sdntrace.switches[x].id.substring(1,16);
                    // positioning in spiral mode to help the physics animation and prevent crossing lines
                    angle = 0.1 * x;
                    node_obj = {id: node_id, label:sdntrace.switches[x].get_node_name(), x:(1+angle)*Math.cos(angle), y:(1+angle)*Math.sin(angle), physics:true, mass:2, borderWidth:1};
                    // Trace coloring
                    if (with_trace && sdntrace.trace && sdntrace.trace.length > 1) {
                        node_obj.color = sdncolor.trace_color_off;
                        for (y = 0; y < sdntrace.trace.length; y++) {
                            if (sdntrace.trace[y].id ==  sdntrace.switches[x].id) {
                                color_code = sdntrace.get_switch_color(sdntrace.switches[x].id)['color']
                                color = sdncolor.get_color(color_code)
                                if (color) {
                                    node_obj.color = {'background' : color};
                                } else {
                                    // color codes are not loaded
                                    node_obj.color = {'background' : sdncolor.trace_color_on};
                                }
                                // Highlighting the first node / start node
                                if (y == 0) {
                                    node_obj.borderWidth = 3;
                                    node_obj.color.border = '#000000';
                                    node_obj.color.highlight = {'border' : '#000000'};
                                }
                            }
                        }
                        if (typeof(node_obj.color)==='undefined') {
                            node_obj.color = {'background' : sdncolor.trace_color_off};
                        }
                    }
                    if (with_colors && sdntrace.switch_colors && sdntrace.switch_colors.length > 0) {
                        color_code = sdntrace.get_switch_color(sdntrace.switches[x].id)['color']
                        node_obj.color = {'background' : sdncolor.get_color(color_code)};
                    }

                    if (typeof(node_obj.color)==='undefined') {
                        node_obj.color = {'background' : sdncolor.color_default};
                    }

                    nodesArray.push(node_obj);
                }
                this.nodes = new vis.DataSet(nodesArray);
            }

            /**
             * Create VIS network edges.
             * This function can be used to create the topology, topology with color and
             * topology with tracing.
             */
            this._create_network_edges = function(with_colors, with_trace) {
                var edgesArray = [];
                // verify topology to create edges
                for (var x = 0; x < sdntrace.topology.length; x++) {
                    for (var y = 0; y < sdntrace.topology[x]['val'].length; y++) {
                        node_from_id = sdntrace.topology[x]['key'].substring(1,16);
                        node_to_id = sdntrace.topology[x]['val'][y].substring(1,16);
                        edgeObj = {id:x+'_'+y, from: node_from_id, to: node_to_id, arrows:'to', smooth: {type: "dynamic"}};
                        // Verify trace to change edge colors and labels.
                        if (with_trace) {
                            if (sdntrace.trace) {
                                for (var z = 1; z < sdntrace.trace.length; z++) {
                                    trace_node_from_id = sdntrace.trace[z-1].id.substring(1,16);
                                    trace_node_to_id = sdntrace.trace[z].id.substring(1,16);

                                    if (trace_node_from_id == node_from_id && trace_node_to_id == node_to_id) {
                                        label = ''
                                        if (sdntrace.trace[z-1].port) {
                                            label += 'in=' + sdntrace.trace[z-1].port + "\n";
                                        }
                                        if (sdntrace.trace[z].port) {
                                            label += 'out=' + sdntrace.trace[z].port;
                                        }

                                        color_code = sdntrace.get_switch_color(sdntrace.trace[z-1].id)['color']
                                        color = sdncolor.get_color(color_code);
                                        if (color) {
                                            edgeObj.color = color
                                        } else {
                                            // color codes are not loaded
                                            edgeObj.color = sdncolor.trace_color_on;
                                        }

                                        edgeObj.label = label;
                                        break;
                                    }
                                    // if it is not a trace edge, set the default color.
                                    if (!edgeObj.color) {
                                        edgeObj.color = sdncolor.trace_color_off;
                                    }
                                }
                            }
                            // if it is not a trace edge, set the default color.
                            if (!edgeObj.color) {
                                edgeObj.color = sdncolor.color_default;
                            }
                        }
                        edgesArray.push(edgeObj);
                    }
                }

                if (with_trace) {
                    // adding loop trace
                    if (sdntrace.has_trace_loop && sdntrace.trace && sdntrace.trace.length > 0) {
                        // selecting the first switch to loop
                        trace_node_id = sdntrace.trace[0].id.substring(1,16);
                        // expecting just one loop, otherwise we have an error with duplicated IDs
                        edgeObj = {id:'0_loop', from: trace_node_id, to: trace_node_id, arrows:'to', smooth: {type: "dynamic"}};
                        color_code = sdntrace.get_switch_color(sdntrace.trace[0].id)['color']
                        color = sdncolor.get_color(color_code);
                        if (color) {
                            edgeObj.color = color
                        } else {
                            // color codes are not loaded
                            edgeObj.color = sdncolor.trace_color_on;
                        }
                        edgesArray.push(edgeObj);
                    }
                }
                this.edges = new vis.DataSet(edgesArray);
            }

            this._render_network = function(with_colors, with_trace) {
                with_colors = typeof with_colors !== 'undefined' ? with_colors : true;
                with_trace = typeof with_trace !== 'undefined' ? with_trace : true;

                this.resetAllNodes();
                // create an array with nodes
                this._create_network_nodes(with_colors, with_trace);

                // create an array with edges
                this._create_network_edges(with_colors, with_trace);

                // create a network
                var container = document.getElementById('mynetwork');
                var data = {
                    nodes: this.nodes,
                    edges: this.edges
                };
                // network physics
                var options = {
                    autoResize: true,
                    "edges": {
                        "smooth": {
                          "forceDirection": "none"
                        }
                      },
                      "physics": {
                        "barnesHut": {
                          "springLength": 100,
                          "springConstant": 0.05,
                          "avoidOverlap": 0.1
                        },
                        "minVelocity": 0.75,
                      }
                }
                var flag_first_afterDrawing = true;
                var flag_first_stabilized = true;
                var network = new vis.Network(container, data, options);

                // Trying to fit the network to viewport.
                network.on("stabilized", function (ctx) {
                    if (flag_first_stabilized) {
                        flag_first_stabilized = false;
                        this.fit();
                    }
                });
                // Sometimes the viewport is not properly rendered
                // so we have to fit again afterDrawing.
                // The flag must stop the fitting, because it will
                // draw the network again.
                // It can cause a visual glitch if the network is not stabilized.
                network.on("afterDrawing", function (ctx) {
                    if (flag_first_afterDrawing) {
                        flag_first_afterDrawing = false;
                        this.fit();
                    }
                });
            }

            this.resetAllNodes = function() {
                if (this.nodes) {
                    this.nodes.clear();
                }
                if (this.edges) {
                    this.edges.clear();
                }
            }

            var changeOptions = function(){
                var newColor = '#' + Math.floor((Math.random() * 255 * 255 * 255)).toString(16);
                /*
                edges.update([{id:'1', color:'black'}]);
                edges.update([{id:'2', color:'darkred'}]);
                edges.update([{id:'3', color:'darkblue'}]);
                edges.update([{id:'4', color:'cyan'}]);
                edges.update([{id:'5', color:'gray'}]);
                edges.update([{id:'6', color:'brown'}]);
                edges.update([{id:'7', color:'green'}]);
                */
            }
        }

        /* Form validation. */
        var _initialize_form_validation = function(){
            // IPv4 mask
            // $('#l3_nw_src').mask('099.099.099.099');
            // $('#l3_nw_dst').mask('099.099.099.099');
            // $('#lf_nw_src').mask('099.099.099.099');
            // $('#lf_nw_dst').mask('099.099.099.099');
            // VLAN
            $('#l2_dl_vlan').mask('0#');
            $('#l3_dl_vlan').mask('0#');
            $('#lf_dl_vlan').mask('0#');
            // TCP
            $('#lf_tp_src').mask('0#');
            $('#lf_tp_dst').mask('0#');
            $('#l3_tp_src').mask('0#');
            $('#l3_tp_dst').mask('0#');
            // TOS
            $('#lf_nw_tos').mask('0#');
            $('#l3_nw_tos').mask('0#');
        }

        /* Initial data lod */
        /* Call ajax to load switches and topology */
        var _initial_data_load = function() {
            // Clearing contents
            $('#switches_select').html("<option>---</option>");
            $('#switch-ports-content').html('');
            $('#switches_topology_text').html('');

            // Hiding panels
            $('#switch-ports').hide();
            $('#trace-result-panel').hide();
            $('#topology-panel').hide();
            $('#mynetwork').hide();

            // load switches data
            sdntrace.call_get_switches();
            // load topology data
            sdntrace.call_get_topology();
        }

        /* Initial configuration */
        var _initial_configuration = function() {
            if (typeof SDNTRACE_CONF != 'undefined') {
                // header logo img src
                $('#id-header-logo').attr("src", SDNTRACE_CONF.header_logo_img_src);
                // header name
                $('#id-header-name').text(SDNTRACE_CONF.header_name);
                // SDNTrace version
                $('#id-span-version').text(SDNTRACE_CONF.version);
            }
        }

        /* Initial load */
        $(function() {
            _initial_configuration();

            sdntrace = new SDNTrace();
            sdncolor = new SDNColor();
            vislib = new VIS();


            // Setup VIS modal
            $(".modal-wide").on("show.bs.modal", function() {
              var height = $(window).height() - 200;
              $(this).find(".modal-body").css("max-height", height);
            });

            // Setup collapsible topology list
            $('#collapse_topology_panel').on('shown.bs.collapse', function () {
               $("#collapse_topology_icon").removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-up");
            });

            $('#collapse_topology_panel').on('hidden.bs.collapse', function () {
               $("#collapse_topology_icon").removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down");
            });
            // Switch select change event to show ports
            $('#switches_select').change(function() {
                sdntrace.call_get_switch_port($('#switches_select').val());
            });

            // Trace form click events to submit forms
            $('#layer2_btn').click(function() {
                jsonStr = sdntrace._build_trace_layer2_json();
                sdntrace.call_trace_port(jsonStr);
            });
            $('#layer3_btn').click(function() {
                jsonStr = sdntrace._build_trace_layer3_json();
                sdntrace.call_trace_port(jsonStr);
            });
            $('#layerfull_btn').click(function() {
                jsonStr = sdntrace._build_trace_layerfull_json();
                sdntrace.call_trace_port(jsonStr);
            });


            // Render buttons click event to render VIS topology
            $('#render_btn').click(function() {
                $('#mynetwork').show();
                vislib.render_topology();
            });
            // Render buttons click event to render VIS topology with colors
            $('#render_colors_btn').click(function() {
                // sdntrace.call_get_switch_colors();
                sdntrace.render_html_topology();
                vislib.render_topology_colors();
            });
            // Render buttons click event to render VIS topology with tracing
            $('#render_trace_btn').click(function() {
                // triggering the html render because the topology may be empty.
                sdntrace.render_html_topology();
                vislib.render_topology_trace();
            });

            // Button reload data
            $('#sdn-server-reload-btn').click(function() {
                _initial_data_load();
            });

            // initialize form validators (IPv4 fields)
            _initialize_form_validation();

            // initial data load (switch list, topology, colors)
            _initial_data_load();
        });

        /**
         * Helper function to remove duplicates from an array.
         */
        function array_unique_fast(a) {
            var seen = {};
            var out = [];
            var len = a.length;
            var j = 0;
            for(var i = 0; i < len; i++) {
                 var item = a[i];
                 if(seen[item] !== 1) {
                       seen[item] = 1;
                       out[j++] = item;
                 }
            }
            return out;
        }
  </script>
</head>
<body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">
                    <div>
                        <span><img id="id-header-logo" class="logo-header" src="" ></span>
                        <span id="id-header-name">SDNTrace</span>
                    </div>
                </a>
            </div>
            <div id="navbar" class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="#">Home</a></li>
                    <li><a href="#about" data-toggle="modal" data-target="#gridAboutModal">About</a></li>
                </ul>
            </div><!--/.nav-collapse -->
        </div>
    </nav>

    <div class="container">
        <div class="starter-template">
            <div class="row">
                <div class="col-md-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">Switches</div>
                        <div class="panel-body">
                            <!-- Switches list -->
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="col-md-2">
                                        <label for="switches_select">Switches:</label>
                                    </div>
                                    <select id="switches_select">
                                        <option>----</option>
                                    </select>
                                </div>
                            </div>
                            <div id="switch-ports" class="row">
                                <!-- Ports list -->
                                <div id="switch-ports-heading" class="col-md-12">
                                    <div class="col-md-2">
                                        <label>Ports:</label>
                                    </div>
                                    <input type="hidden" name="switch_port_hidden" id="switch_port_hidden" >
                                    <div id="switch-ports-content" class="col-md-10"></div>
                                </div>
                                <!-- Trace forms -->
                                <div id="switch-ports-layer-form-content" class="col-md-12 form-horizontal">
                                    <div>
                                        <!-- Nav tabs -->
                                        <ul class="nav nav-tabs" role="tablist"><li role="presentation" class="active"><a href="#trace-layer-2" aria-controls="trace-layer-2" role="tab" data-toggle="tab">Trace Layer 2</a></li>
                                            <li role="presentation"><a href="#trace-layer-3" aria-controls="trace-layer-3" role="tab" data-toggle="tab">Trace Layer 3</a></li>
                                            <li role="presentation"><a href="#trace-layer-full" aria-controls="trace-layer-full" role="tab" data-toggle="tab">Trace Full</a></li>
                                        </ul>
                                        <!-- Tab panes -->
                                        <div class="tab-content">
                                            <!-- Tab panes - Form layer 2 trace -->
                                            <div role="tabpanel" class="tab-pane active" id="trace-layer-2">
                                                <div class="panel panel-default">
                                                    <div class="panel-body">
                                                        <form id="maskFormLayer2" method="post" class="form-horizontal">
                                                            <div class="form-group">
                                                                <label for="l2_dl_src" class="col-sm-2 control-label">MAC Origem</label>
                                                                <div class="col-sm-10">
                                                                    <input class="form-control" type="text" id="l2_dl_src" name="l2_dl_src" placeholder="MAC Origem">
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="l2_dl_dst" class="col-sm-2 control-label">MAC Destino</label>
                                                                <div class="col-sm-10">
                                                                    <input class="form-control" type="text" id="l2_dl_dst" name="l2_dl_dst" placeholder="MAC Destino">
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="l2_dl_vlan" class="col-sm-2 control-label">VLAN</label>
                                                                <div class="col-sm-10">
                                                                    <input class="form-control" type="text" id="l2_dl_vlan" name="l2_dl_vlan" placeholder="VLAN">
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="l2_dl_type" class="col-sm-2 control-label">Ethertype</label>
                                                                <div class="col-sm-10">
                                                                    <input class="form-control" type="text" id="l2_dl_type" name="l2_dl_type" placeholder="Ethertype">
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <div class="col-sm-offset-2 col-xs-3 col-sm-3">
                                                                    <button type="button" class="btn btn-default" id="layer2_btn">Trace Layer 2</button>
                                                                </div>
                                                                <div class="col-xs-7 col-sm-7 loading-icon-div">
                                                                    <img src="./ajax-loader.gif" />
                                                                </div>
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- Tab panes - Form layer 3 trace -->
                                            <div role="tabpanel" class="tab-pane" id="trace-layer-3">
                                                <div class="panel panel-default">
                                                    <div class="panel-body">
                                                        <form id="maskFormLayer3" method="post" class="form-horizontal">
                                                            <div class="form-group">
                                                                <label for="l3_dl_vlan" class="col-sm-2 control-label">VLAN</label>
                                                                <div class="col-sm-10">
                                                                    <input class="form-control" type="text" id="l3_dl_vlan" name="l3_dl_vlan" placeholder="VLAN">
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="l3_nw_src" class="col-sm-2 control-label">IP de Origem</label>
                                                                <div class="col-sm-10">
                                                                    <input class="form-control ip_address" type="text" id="l3_nw_src" name="l3_nw_src" placeholder="IP de Origem">
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="l3_nw_dst" class="col-sm-2 control-label">IP de Destino</label>
                                                                <div class="col-sm-10">
                                                                    <input class="form-control ip_address" type="text" id="l3_nw_dst" name="l3_nw_dst" placeholder="IP de Destino">
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="l3_nw_tos" class="col-sm-2 control-label">TOS</label>
                                                                <div class="col-sm-10">
                                                                    <input class="form-control" type="text" id="l3_nw_tos" name="l3_nw_tos" placeholder="TOS">
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="l3_tp_src" class="col-sm-2 control-label">TCP de Origem</label>
                                                                <div class="col-sm-10">
                                                                    <input class="form-control" type="text" id="l3_tp_src" name="l3_tp_src" placeholder="TCP de Origem">
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="l3_tp_dst" class="col-sm-2 control-label">TCP de Destino</label>
                                                                <div class="col-sm-10">
                                                                    <input class="form-control" type="text" id="l3_tp_dst" name="l3_tp_dst" placeholder="TCP de Destino">
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                               <div class="col-sm-offset-2 col-xs-3 col-sm-3">
                                                                    <button type="button" class="btn btn-default" id="layer3_btn">Trace Layer 3</button>
                                                                </div>
                                                                <div class="col-xs-7 col-sm-7 loading-icon-div">
                                                                    <img src="./ajax-loader.gif" />
                                                                </div>
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- Tab panes - Form full trace -->
                                            <div role="tabpanel" class="tab-pane" id="trace-layer-full">
                                                <div class="panel panel-default">
                                                    <div class="panel-body">
                                                        <form id="maskFormLayerFull" method="post" class="form-horizontal">
                                                            <div class="form-group">
                                                                <label for="lf_dl_src" class="col-sm-2 control-label">MAC Origem</label>
                                                                <div class="col-sm-10">
                                                                    <input class="form-control" type="text" id="lf_dl_src" name="lf_dl_src" placeholder="MAC Origem">
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="lf_dl_dst" class="col-sm-2 control-label">MAC Destino</label>
                                                                <div class="col-sm-10">
                                                                    <input class="form-control" type="text" id="lf_dl_dst" name="lf_dl_dst" placeholder="MAC Destino">
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="lf_dl_vlan" class="col-sm-2 control-label">VLAN</label>
                                                                <div class="col-sm-10">
                                                                    <input class="form-control" type="text" id="lf_dl_vlan" name="lf_dl_vlan" placeholder="VLAN">
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="lf_dl_type" class="col-sm-2 control-label">Ethertype</label>
                                                                <div class="col-sm-10">
                                                                    <input class="form-control" type="text" id="lf_dl_type" name="lf_dl_type" placeholder="Ethertype">
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="lf_nw_src" class="col-sm-2 control-label ip_address">IP de Origem</label>
                                                                <div class="col-sm-10">
                                                                    <input class="form-control" type="text" id="lf_nw_src" name="lf_nw_src" placeholder="IP de Origem">
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="lf_nw_dst" class="col-sm-2 control-label ip_address">IP de Destino</label>
                                                                <div class="col-sm-10">
                                                                    <input class="form-control" type="text" id="lf_nw_dst" name="lf_nw_dst" placeholder="IP de Destino">
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="lf_nw_tos" class="col-sm-2 control-label">TOS</label>
                                                                <div class="col-sm-10">
                                                                    <input class="form-control" type="text" id="lf_nw_tos" name="lf_nw_tos" placeholder="TOS">
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="lf_tp_src" class="col-sm-2 control-label">TCP de Origem</label>
                                                                <div class="col-sm-10">
                                                                    <input class="form-control" type="text" id="lf_tp_src" name="lf_tp_src" placeholder="TCP de Origem">
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="lf_tp_dst" class="col-sm-2 control-label">TCP de Destino</label>
                                                                <div class="col-sm-10">
                                                                    <input class="form-control" type="text" id="lf_tp_dst" name="lf_tp_dst" placeholder="TCP de Destino">
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <div class="col-sm-offset-2 col-xs-3 col-sm-3">
                                                                    <button type="button" class="btn btn-default" id="layerfull_btn">Trace Full</button>
                                                                </div>
'                                                                <div class="col-xs-7 col-sm-7 loading-icon-div">
                                                                    <img src="./ajax-loader.gif" />
                                                                </div>
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="panel panel-default" id="trace-result-panel">
                                                <div class="panel-body">
                                                    <div id="trace-result-content">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-12">
                    <div id="topology-panel" class="panel panel-default ">
                        <div class="panel-heading">
                            <a data-toggle="collapse" href="#collapse_topology_panel">Topology</a>
                            <span id="collapse_topology_icon" class='glyphicon glyphicon-chevron-down' aria-hidden='true'></span>
                            <button id="render_btn" type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#id_modal_network">
                              Render topology
                            </button>
                            <button id="render_colors_btn" type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#id_modal_network">
                              Render colors
                            </button>
                            <button id="render_trace_btn" type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#id_modal_network">
                              Render trace
                            </button>
                        </div>
                        <div id="collapse_topology_panel" class="panel-collapse collapse">
                            <div class="row">
                                <div id="switches_topology_text" class="col-md-12">
                                    <!-- dynamic content -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
<!-- Button trigger modal -->

            </div>

            <div class="col-md-12">

<!-- Modal -->
<div class="modal fade" id="id_modal_network" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel5" aria-hidden="true">
  <div class="modal-dialog " role="document">
    <div class="modal-content" style="background-color:white">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <!--<button type="button" id="render_btn2" class="btn btn-primary btn-sm">Render topology</button>-->
        <!--<button type="button" id="render_colors_btn2" class="btn btn-primary btn-sm">Render colors</button>-->
        <!--<button type="button" id="render_trace_btn23" class="btn btn-primary btn-sm">Render trace</button>-->
        <div id="mynetwork">
            <div class="vis-network" tabindex="900" style="position: relative; overflow: hidden; touch-action: pan-y; -webkit-user-select: none; -webkit-user-drag: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); width: 100%; height: 100%;">
                <canvas id="vis-canvas" width="500" height="850" style="position: relative; touch-action: none; -webkit-user-select: none; -webkit-user-drag: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); width: 100%; height: 100%;"></canvas>
            </div>
        </div>
</div>
  </div>
</div>
            </div>
        </div>
    </div><!-- /.container -->

    <div id="gridAboutModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="gridAboutModalLabel">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="gridAboutModalLabel">SDNTrace <span id="id-span-version"></span></h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12">
                            <p>The SDNTrace was written by Jeronimo Bezerra, Antonio J. F. Francisco and Rogerio S. Motitsuki.</p>
                            <p>The source-code is available on <a href="https://github.com/amlight/SDNTrace">Amlight GitHub</a>.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
    </div>
</body>
</html>








